#!/usr/bin/env python
# coding: utf-8
"""
    writeup
    ~~~~~~~

    Writeup the binary.

    :copyright: (c) 2013 Hsiaoming Yang
"""

import sys
import writeup
from terminal.builtin import Command


program = Command('writeup', version=writeup.__version__)


@program.subcommand
def build(config='_config.yml', source='.', dest='_site',
          postsdir='_posts', force=False):
    """Build your site.

    :param config: Custom configuration file
    :param source: Source for the site
    :param dest: Output for the destination
    :param postsdir: Specify the post directory
    :param force: Ignore cache, force build the site
    """
    from writeup.builder import Builder
    builder = Builder(
        config=config, source=source, sitedir=dest,
        postsdir=postsdir, force=force,
    )
    builder.build()


@program.subcommand
def serve(config='_config.yml', source='.', dest='_site',
          postsdir='_posts', force=False, host='0.0.0.0', port=4000):
    """Start a preview server.

    :param config: Custom configuration file
    :param source: Source for the site
    :param dest: Output for the destination
    :param postsdir: Specify the post directory
    :param host: define server hostname
    :param port: define server port
    :param force: Ignore cache, force build the site
    """
    from writeup.builder import Builder
    from writeup.server import Server

    builder = Builder(
        config=config, source=source, sitedir=dest,
        postsdir=postsdir, force=force,
    )
    builder.build()
    server = Server(dest)

    try:
        from livereload import Server as LiveServer

        liveserver = LiveServer(server.wsgi)
        liveserver.watch(postsdir, builder.build)
        liveserver.serve(port=port)
    except ImportError:
        try:
            server.serve_forever(host, port)
        except KeyboardInterrupt:
            print('\rShut down.')
            sys.exit()


if not program.parse():
    program.print_help()
